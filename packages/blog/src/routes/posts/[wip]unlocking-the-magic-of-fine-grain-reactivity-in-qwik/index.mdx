# Read

- [A Hands-on Introduction to Fine-Grained Reactivity](https://dev.to/ryansolid/a-hands-on-introduction-to-fine-grained-reactivity-3ndf)
- [Building a Reactive Library from Scratch](https://dev.to/ryansolid/building-a-reactive-library-from-scratch-1i0p)
- [My Take on a Unified Theory of Reactivity](https://www.builder.io/blog/unified-reactivity-theory)
- [A Brief History of Reactivity](https://www.builder.io/blog/history-of-reactivity)
- [Unveiling the Magic: Exploring Reactivity Across Various Frameworks](https://www.builder.io/blog/reactivity-across-frameworks)
- [Reactâ€™s Upcoming Compiler Only Solves Part Of The Problem](https://www.builder.io/blog/react-compiler-will-not-solve-prop-drilling)

## Not Read

- [SolidJS: Reactivity to Rendering](https://indepth.dev/posts/1289/solidjs-reactivity-to-rendering)
- [Becoming fully reactive: an in-depth explanation of MobX](https://medium.com/hackernoon/becoming-fully-reactive-an-in-depth-explanation-of-mobservable-55995262a254)

- What is SignalImpl?
- What is SignalDerived?
- What is the reactivity graph?
- Does Qwik support dynamic subscription?
- How does a subscription happen?
- How does a notification happen?
- How does a un-subscription happen?

{/* prettier-ignore-start */}
```tsx
// q:id=6
export const Reactivity = component$(() => {
  const firstName = useSignal('John');
  const lastName = useSignal('Smith');
  const showFullName = useSignal(true);

  const displayName = useComputed$(() => {
    if (!showFullName.value) return firstName.value;
    return `${firstName.value} ${lastName.value}`;
  });

  return (
    <div>
      <h1>
        Display Name:
        {/* q:id=7 */}
        {displayName.value}
      </h1>
      <div>
        {/* q:id=8 */}
        <button onClick$={() => (showFullName.value = true)}>show full name</button>
        {/* q:id=9 */}
        <button onClick$={() => (showFullName.value = false)}>only show first name</button>
      </div>
      <div>
        {/* q:id=a */}
        <button onClick$={() => (firstName.value = 'Leo')}>Set first name to Leo</button>
        {/* q:id=b */}
        <button onClick$={() => (lastName.value = 'Nerd')}>Set last name to Nerd</button>
      </div>
      <div>
        {/* q:id=c */}
        <button onClick$={() => (firstName.value = 'Una')}>Set first name to Una</button>
        {/* q:id=d */}
        <button onClick$={() => (lastName.value = 'Chen')}>Set last name to Chen</button>
      </div>
    </div>
  );
});
```
{/* prettier-ignore-end */}

{/* prettier-ignore-start */}
```json
{
  "refs": {
    "8": "3", // element 8 (show full name button) closes over object 3 (signal showFullName)
    "9": "3", // element 9 (show full name button) closes over object 3 (signal showFullName)
    "a": "0", // element a (set first name to leo button) closes over object 0 (signal firstName)
    "b": "1", // element b (set last name to nerd button) closes over object 0 (signal lastName)
    "c": "0", // element c (set first name to una button) closes over object 0 (signal firstName)
    "d": "1"  // element d (set last name to chen button) closes over object 0 (signal lastName)
  },
  "ctx": {},
  "objs": [
    /* 0 */ "\u00125", // firstName signal with object 5 as its value
    /* 1 */ "\u00126", // lastName signal with object 6 as its value
    /* 2 */ "\u0012*7", // a signal with text element as its value
    /* 3 */ "\u00124", // showFullName signal with object 4 as its value
    /* 4 */ true,
    /* 5 */ "John",
    /* 6 */ "Smith",
    /* 7 */ "\u0002/src/reactivity_component_displayname_usecomputed_qzk1i2drlt4.js#Reactivity_component_displayName_useComputed_Qzk1i2DrlT4[0 1 3]", // a QRL <chunk>#<symbol>[<capture>]
    /* 8 */ "\u00112 @0", // signal derived with object 2 as its argument and (p0) => p0.value as its transform function
    /* 9 */ "#7", // the {displayName.value} text node
    /* a */ "\u0003a 3 7 #6 2" // a task [flags, index, qrl, el, resource]
  ],
  "subs": [
    /* 0 */ ["0 a"], // object 0 has a type 0 subscription from the host object a
    /* 1 */ ["0 a"], // object 1 has a type 0 subscription from the host object a
    /* 2 */ ["3 #7 8 #7"], // object 2 has a type 3 subscription from the host #7 and the signal is object 8
    /* 3 */ ["0 a"] // object 3 has a type 0 subscription from the host object a
  ]
}
```
{/* prettier-ignore-end */}

```js
[(p0) => p0.value];
```

`InvokeContext` stores the current invoke context. When this invoke function call the `someSignal.value`, the getter of that signal will add the subscriber onto its subscriptions array in the `LocalSubscriptionManager`.

```ts
export interface InvokeContext {
  $url$: URL | undefined;
  $seq$: number;
  $hostElement$: QwikElement | undefined;
  $element$: Element | undefined;
  $event$: any | undefined;
  $qrl$: QRL<any> | undefined;
  $waitOn$: Promise<any>[] | undefined;
  $subscriber$: Subscriber | null | undefined;
  $renderCtx$: RenderContext | undefined;
  $locale$: string | undefined;
}
```

That's why when some context is invoked, Qwik will replace the invokeContext and restore the original one back after the `invoke` is finished.

```ts
export function invoke<ARGS extends any[] = any[], RET = any>(
  this: any,
  context: InvokeContext | undefined,
  fn: (...args: ARGS) => RET,
  ...args: ARGS
): RET {
  const previousContext = _context;
  let returnValue: RET;
  try {
    _context = context;
    returnValue = fn.apply(this, args);
  } finally {
    _context = previousContext;
  }
  return returnValue;
}
```

Contexts:

- InvokeContext

  Will be stored in `_context` of the `use-core` module.

  ```ts
  export interface InvokeContext {
    $url$: URL | undefined;
    $seq$: number;
    $hostElement$: QwikElement | undefined;
    $element$: Element | undefined;
    $event$: any | undefined;
    $qrl$: QRL<any> | undefined;
    $waitOn$: Promise<any>[] | undefined;
    $subscriber$: Subscriber | null | undefined;
    $renderCtx$: RenderContext | undefined;
    $locale$: string | undefined;
  }
  ```

  `runComputed` will create a new InvokeContext and add itself as `$subscriber$`.

- QContext

  Will be stored in `element["_qc_"]`.

  ```ts
  export interface QContext {
    // the element which owns this context
    $element$: QwikElement;
    // the references of cross over variables
    // ex: [SignalImpl, SignalDerived, ...]
    $refMap$: any[];
    $flags$: number;
    $id$: string;
    $props$: Record<string, any> | null;
    $componentQrl$: QRLInternal<OnRenderFn<any>> | null;
    // parse the attributes into DOM listeners
    // ex: [['on:click', QRL]]
    li: Listener[];
    $seq$: any[] | null;
    $tasks$: SubscriberEffect[] | null;
    $contexts$: Map<string, any> | null;
    $appendStyles$: StyleAppend[] | null;
    $scopeIds$: string[] | null;
    $vdom$: ProcessedJSXNode | null;
    $slots$: ProcessedJSXNode[] | null;
    $dynamicSlots$: QContext[] | null;
    $parent$: QContext | null;
    $slotParent$: QContext | null;
  }
  ```
